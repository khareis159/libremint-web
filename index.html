<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LibreMint - Raspadinha Interativa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #667eea;
            margin: 0;
        }

        .wallet-info {
            text-align: right;
        }

        .wallet-info .balance {
            font-size: 1.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .wallet-info .address {
            font-size: 0.9em;
            color: #666;
        }

        .onboarding {
            background: white;
            padding: 40px;
            border-radius: 10px;
            max-width: 500px;
            margin: 100px auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .onboarding h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .game-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .package-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .package-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .package-card.selected {
            border: 4px solid #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .package-card .price {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin: 30px 0;
        }

        .scratch-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
            position: relative;
        }

        .scratch-card:hover:not(.revealed) {
            transform: scale(1.05);
        }

        .scratch-card.prize {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            animation: pulse 0.5s;
        }

        .scratch-card.no-prize {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #667eea;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .prize-summary {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #ffc107;
            margin: 20px 0;
        }

        .prize-summary h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .prize-summary .total {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }

        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.75em;
            max-height: 150px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Onboarding -->
    <div id="onboarding" class="onboarding">
        <h2>🪙 Bem-vindo ao LibreMint!</h2>
        <p>Crie sua carteira para jogar a Raspadinha Interativa.</p>
        
        <div class="form-group">
            <label>Escolha seu apelido:</label>
            <input type="text" id="nickname" placeholder="Digite seu apelido" maxlength="20">
        </div>

        <button class="btn" onclick="createWallet()">Criar Minha Carteira</button>
        
        <div id="onboardingAlert"></div>
        <div id="debugLog" class="debug-log"></div>
    </div>

    <!-- Aplicação Principal -->
    <div id="mainApp" class="container hidden">
        <div class="header">
            <div>
                <h1>🪙 LibreMint Raspadinha</h1>
            </div>
            <div class="wallet-info">
                <div class="balance" id="userBalance">Carregando...</div>
                <div class="address" id="userAddress">Carregando...</div>
                <div class="address">
                    <span id="userNickname"></span>
                </div>
            </div>
        </div>

        <!-- Seleção de Pacote -->
        <div class="game-container" id="packageSelection">
            <h2 style="margin-bottom: 20px; color: #667eea;">Escolha seu Pacote</h2>
            <div class="package-selection">
                <div class="package-card" onclick="selectPackage(1, 10)">
                    <div>Pacote Básico</div>
                    <div class="price">1 LM</div>
                    <div>10 cartões</div>
                </div>
                <div class="package-card" onclick="selectPackage(2, 20)">
                    <div>Pacote Médio</div>
                    <div class="price">2 LM</div>
                    <div>20 cartões</div>
                </div>
                <div class="package-card" onclick="selectPackage(3, 30)">
                    <div>Pacote Premium</div>
                    <div class="price">3 LM</div>
                    <div>30 cartões</div>
                </div>
            </div>
            <button class="btn" onclick="startGame()" id="startButton" disabled>Iniciar Jogo</button>
            <div id="packageAlert"></div>
        </div>

        <!-- Conversor -->
        <div class="game-container">
            <h2 style="margin-bottom: 20px; color: #667eea;">Simulador de Conversão</h2>
            <div class="alert alert-info">
                Taxa de Câmbio: <strong>1 LM = R$ 1.000,00</strong>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Valor em LM:</label>
                    <input type="number" id="inputLM" placeholder="0.0000" step="0.0001" oninput="convertLMtoBRL(this.value)">
                </div>
                <div class="form-group">
                    <label>Valor em BRL (R$):</label>
                    <input type="number" id="inputBRL" placeholder="0.00" step="0.01" oninput="convertBRLtoLM(this.value)">
                </div>
            </div>
        </div>

        <!-- Tabuleiro do Jogo -->
        <div class="game-container hidden" id="gameBoard">
            <h2 style="margin-bottom: 20px; color: #667eea;">Raspe os Cartões!</h2>
            <div class="game-board" id="scratchCards"></div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="value" id="cardsRevealed">0</div>
                    <div>Cartões Raspados</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="prizesFound">0</div>
                    <div>Prêmios Encontrados</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="currentPrize">0 LM</div>
                    <div>Prêmio Atual</div>
                </div>
            </div>
        </div>

        <!-- Resumo do Prêmio -->
        <div class="game-container hidden" id="prizeSummary">
            <div class="prize-summary">
                <h3>🎉 Parabéns! Você ganhou:</h3>
                <div class="total" id="totalPrize">0 LM</div>
                <p style="margin-top: 10px;">O prêmio foi creditado em sua carteira!</p>
            </div>
            <button class="btn btn-secondary" onclick="resetGame()">Jogar Novamente</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ========== CONFIGURAÇÃO ==========
        const firebaseConfig = {
            apiKey: "AIzaSyA5suVRJ9KrNq7RG6Ui8nfyuHhgFLWedns",
            authDomain: "libremint-2025.firebaseapp.com",
            databaseURL: "https://libremint-2025-default-rtdb.firebaseio.com",
            projectId: "libremint-2025",
            storageBucket: "libremint-2025.firebasestorage.app",
            messagingSenderId: "443804344775",
            appId: "1:443804344775:web:cf09abf9bb2637ae8bf9e2"
        };

        const EXCHANGE_RATE = 1000;
        const PRIZE_MULTIPLIERS = [0.5, 1, 1.5, 2, 3, 5];

        // ========== VARIÁVEIS GLOBAIS ==========
        let database;
        let currentUser = null;
        let selectedPackage = null;
        let gameState = { cards: [], revealed: 0, prizes: 0, totalPrize: 0 };

        // ========== LIBREMINT CORE ==========
        const LM = {
            SAT_PER_LM: 100000000,
            
            lmToSat(lm) {
                return Math.round(lm * this.SAT_PER_LM);
            },
            
            satToLm(sat) {
                return sat / this.SAT_PER_LM;
            },
            
            formatLM(lm, decimals = 4) {
                return parseFloat(lm).toFixed(decimals);
            },
            
            formatSat(sat) {
                return Math.round(sat).toLocaleString('pt-BR');
            },
            
            brlToLm(brl) {
                return brl / EXCHANGE_RATE;
            },
            
            lmToBrl(lm) {
                return lm * EXCHANGE_RATE;
            },
            
            brlToSat(brl) {
                return this.lmToSat(this.brlToLm(brl));
            },
            
            satToBrl(sat) {
                return this.lmToBrl(this.satToLm(sat));
            },

            log(msg) {
                const time = new Date().toLocaleTimeString();
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += `[${time}] ${msg}<br>`;
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
                console.log(msg);
            }
        };

        // ========== FIREBASE ==========
        const DB = {
            async init() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    LM.log('✅ Firebase inicializado');
                    return true;
                } catch (error) {
                    LM.log('❌ Erro Firebase: ' + error.message);
                    return false;
                }
            },

            async set(path, data) {
                try {
                    await database.ref(path).set(data);
                    LM.log(`✅ Salvo: ${path}`);
                    return true;
                } catch (error) {
                    LM.log(`❌ Erro ao salvar: ${error.message}`);
                    return false;
                }
            },

            async update(path, data) {
                try {
                    await database.ref(path).update(data);
                    LM.log(`✅ Atualizado: ${path}`);
                    return true;
                } catch (error) {
                    LM.log(`❌ Erro ao atualizar: ${error.message}`);
                    return false;
                }
            },

            async get(path) {
                try {
                    const snapshot = await database.ref(path).once('value');
                    return snapshot.val();
                } catch (error) {
                    LM.log(`❌ Erro ao ler: ${error.message}`);
                    return null;
                }
            },

            listen(path, callback) {
                database.ref(path).on('value', (snapshot) => {
                    callback(snapshot.val());
                });
            },

            async push(path, data) {
                try {
                    await database.ref(path).push(data);
                    LM.log(`✅ Adicionado: ${path}`);
                    return true;
                } catch (error) {
                    LM.log(`❌ Erro ao adicionar: ${error.message}`);
                    return false;
                }
            }
        };

        // ========== APLICAÇÃO ==========
        window.onload = async function() {
            LM.log('🚀 Iniciando LibreMint...');
            await DB.init();
            checkExistingWallet();
        };

        function checkExistingWallet() {
            const stored = localStorage.getItem('libremint_wallet');
            if (stored) {
                try {
                    const wallet = JSON.parse(stored);
                    LM.log('✅ Carteira encontrada');
                    loadUserData(wallet.userId);
                } catch (e) {
                    LM.log('❌ Carteira corrompida');
                }
            } else {
                LM.log('ℹ️ Nenhuma carteira encontrada');
            }
        }

        async function createWallet() {
            const nickname = document.getElementById('nickname').value.trim();
            
            if (!nickname || nickname.length < 3) {
                showAlert('onboardingAlert', '⚠️ Digite um apelido válido (min 3 caracteres)', 'danger');
                return;
            }

            LM.log('📝 Criando carteira para: ' + nickname);
            showAlert('onboardingAlert', '⏳ Criando carteira...', 'info');

            try {
                // Gerar dados
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 15);
                const address = 'LM' + btoa(nickname + timestamp).substring(0, 14).toUpperCase();
                const userId = `${nickname.toLowerCase().replace(/[^a-z0-9]/g, '')}_${timestamp}_${random}`;

                // Saldo inicial: 10 LM = 1.000.000.000 satoshis
                const initialBalance = LM.lmToSat(10);

                LM.log(`📋 UserId: ${userId}`);
                LM.log(`💳 Address: ${address}`);
                LM.log(`💰 Saldo inicial: ${initialBalance} sat (10 LM)`);

                // Salvar no Firebase
                const userData = {
                    nickname: nickname,
                    address: address,
                    balanceSat: initialBalance,
                    createdAt: timestamp
                };

                const saved = await DB.set(`users/${userId}`, userData);

                if (!saved) {
                    throw new Error('Falha ao salvar no Firebase');
                }

                // Salvar localmente
                localStorage.setItem('libremint_wallet', JSON.stringify({
                    userId: userId,
                    address: address
                }));

                showAlert('onboardingAlert', '✅ Carteira criada! 10 LM de bônus!', 'success');
                LM.log('🎉 Carteira criada com sucesso!');

                setTimeout(() => {
                    document.getElementById('onboarding').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadUserData(userId);
                }, 1500);

            } catch (error) {
                LM.log('💥 ERRO: ' + error.message);
                showAlert('onboardingAlert', '❌ Erro: ' + error.message, 'danger');
            }
        }

        function loadUserData(userId) {
            LM.log(`📥 Carregando dados: ${userId}`);
            currentUser = userId;
            
            DB.listen(`users/${userId}`, (userData) => {
                if (userData) {
                    LM.log('✅ Dados recebidos do Firebase');
                    updateDisplay(userData);
                } else {
                    LM.log('⚠️ Usuário não encontrado no Firebase');
                    showAlert('packageAlert', '⚠️ Dados não encontrados. Tente recriar a carteira.', 'danger');
                }
            });
        }

        function updateDisplay(userData) {
            const balanceLM = LM.satToLm(userData.balanceSat || 0);
            const balanceSat = userData.balanceSat || 0;

            document.getElementById('userBalance').textContent = `${LM.formatLM(balanceLM, 4)} LM`;
            document.getElementById('userAddress').textContent = `💳 ${userData.address}`;
            document.getElementById('userNickname').textContent = `👤 ${userData.nickname} | 💰 ${LM.formatSat(balanceSat)} sat`;
            
            LM.log(`📊 Saldo: ${balanceLM} LM (${balanceSat} sat)`);
        }

        function selectPackage(lmAmount, cards) {
            selectedPackage = {
                lm: lmAmount,
                sat: LM.lmToSat(lmAmount),
                cards: cards
            };

            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            document.getElementById('startButton').disabled = false;
            LM.log(`📦 Pacote: ${lmAmount} LM, ${cards} cartões`);
        }

        async function startGame() {
            if (!selectedPackage) {
                showAlert('packageAlert', '⚠️ Selecione um pacote', 'danger');
                return;
            }

            LM.log('🎮 Iniciando jogo...');

            const userData = await DB.get(`users/${currentUser}`);
            if (!userData) {
                showAlert('packageAlert', '❌ Erro ao carregar dados', 'danger');
                return;
            }

            const currentBalance = userData.balanceSat || 0;
            LM.log(`💰 Saldo atual: ${currentBalance} sat`);
            LM.log(`💸 Custo: ${selectedPackage.sat} sat`);

            if (currentBalance < selectedPackage.sat) {
                const needed = LM.satToLm(selectedPackage.sat - currentBalance);
                showAlert('packageAlert', 
                    `⚠️ Saldo insuficiente! Faltam ${LM.formatLM(needed, 4)} LM. Contato: 61999487649`, 
                    'danger');
                return;
            }

            const newBalance = currentBalance - selectedPackage.sat;
            const updated = await DB.update(`users/${currentUser}`, {
                balanceSat: newBalance
            });

            if (!updated) {
                showAlert('packageAlert', '❌ Erro ao processar', 'danger');
                return;
            }

            await DB.push('transactions', {
                userId: currentUser,
                userName: userData.nickname,
                type: 'game_purchase',
                amountSat: selectedPackage.sat,
                amountLM: selectedPackage.lm,
                description: `Pacote: ${selectedPackage.cards} cartões`,
                timestamp: Date.now()
            });

            LM.log('✅ Pagamento processado');
            initGame();
        }

        function initGame() {
            document.getElementById('packageSelection').classList.add('hidden');
            document.getElementById('gameBoard').classList.remove('hidden');

            gameState = {
                cards: generateCards(selectedPackage.cards),
                revealed: 0,
                prizes: 0,
                totalPrize: 0
            };

            renderCards();
            LM.log(`🎯 Jogo iniciado: ${selectedPackage.cards} cartões`);
        }

        function generateCards(count) {
            const cards = [];
            const prizeCount = Math.floor(count * 0.3);

            for (let i = 0; i < count; i++) {
                cards.push({
                    id: i,
                    isPrize: i < prizeCount,
                    multiplier: i < prizeCount ? PRIZE_MULTIPLIERS[Math.floor(Math.random() * PRIZE_MULTIPLIERS.length)] : 0,
                    revealed: false
                });
            }

            return cards.sort(() => Math.random() - 0.5);
        }

        function renderCards() {
            const container = document.getElementById('scratchCards');
            container.innerHTML = '';

            gameState.cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'scratch-card';
                cardEl.textContent = '?';
                cardEl.onclick = () => revealCard(card.id);
                container.appendChild(cardEl);
            });
        }

        async function revealCard(cardId) {
            const card = gameState.cards.find(c => c.id === cardId);
            if (!card || card.revealed) return;

            card.revealed = true;
            gameState.revealed++;

            const cardEl = document.querySelectorAll('.scratch-card')[cardId];
            cardEl.classList.add('revealed');

            if (card.isPrize) {
                const prizeAmount = selectedPackage.lm * card.multiplier;
                gameState.prizes++;
                gameState.totalPrize += prizeAmount;

                cardEl.classList.add('prize');
                cardEl.textContent = `${LM.formatLM(prizeAmount, 2)} LM`;
                LM.log(`🎉 Prêmio: ${prizeAmount} LM`);
            } else {
                cardEl.classList.add('no-prize');
                cardEl.textContent = '✗';
            }

            updateStats();

            if (gameState.revealed === selectedPackage.cards) {
                await endGame();
            }
        }

        function updateStats() {
            document.getElementById('cardsRevealed').textContent = gameState.revealed;
            document.getElementById('prizesFound').textContent = gameState.prizes;
            document.getElementById('currentPrize').textContent = `${LM.formatLM(gameState.totalPrize, 2)} LM`;
        }

        async function endGame() {
            document.getElementById('gameBoard').classList.add('hidden');
            document.getElementById('prizeSummary').classList.remove('hidden');

            document.getElementById('totalPrize').textContent = `${LM.formatLM(gameState.totalPrize, 4)} LM`;
            LM.log(`🏁 Fim! Prêmio: ${gameState.totalPrize} LM`);

            if (gameState.totalPrize > 0) {
                const userData = await DB.get(`users/${currentUser}`);
                const currentBalance = userData.balanceSat || 0;
                const prizeSat = LM.lmToSat(gameState.totalPrize);
                const newBalance = currentBalance + prizeSat;

                await DB.update(`users/${currentUser}`, {
                    balanceSat: newBalance
                });

                await DB.push('transactions', {
                    userId: currentUser,
                    userName: userData.nickname,
                    type: 'game_prize',
                    amountSat: prizeSat,
                    amountLM: gameState.totalPrize,
                    description: `Prêmio: ${gameState.prizes} cartões premiados`,
                    timestamp: Date.now()
                });

                LM.log(`💰 Creditado: ${gameState.totalPrize} LM`);
            }
        }

        function resetGame() {
            document.getElementById('prizeSummary').classList.add('hidden');
            document.getElementById('packageSelection').classList.remove('hidden');
            
            selectedPackage = null;
            document.querySelectorAll('.package-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('startButton').disabled = true;
            LM.log('🔄 Jogo reiniciado');
        }

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            if (!message) {
                alertDiv.innerHTML = '';
                return;
            }
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        // Conversor LM <=> BRL
        function convertLMtoBRL(lmValue) {
            const lm = parseFloat(lmValue) || 0;
            const brl = LM.lmToBrl(lm);
            document.getElementById('inputBRL').value = brl.toFixed(2);
        }

        function convertBRLtoLM(brlValue) {
            const brl = parseFloat(brlValue) || 0;
            const lm = LM.brlToLm(brl);
            document.getElementById('inputLM').value = LM.formatLM(lm, 4);
        }
    </script>
</body>
</html>
            